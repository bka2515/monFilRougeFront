"use strict";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],o=!0,n=!1,a=void 0;try{for(var u,c=e[Symbol.iterator]();!(o=(u=c.next()).done)&&(t.push(u.value),!r||t.length!==r);o=!0);}catch(e){n=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(n)throw a}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var __importDefault=function(e){return e&&e.__esModule?e:{default:e}},__importStar=function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r.default=e,r};Object.defineProperty(exports,"__esModule",{value:!0});var fetch_mock_1=__importDefault(require("fetch-mock")),xhr_mock_1=__importStar(require("xhr-mock")),query_string_1=require("query-string");function handleRestMock(e){var r=e.method,t=e.url,o=e.response,n=e.responseCode,a=void 0===n?200:n,u=e.responseHeaders,c=e.delay,i=void 0===c?0:c,l={body:o,status:a,headers:u};switch(r){case"GET":fetch_mock_1.default.get(t,function(){return addDelay(i).then(function(){return l})},{overwriteRoutes:!1}),xhr_mock_1.default.get(t,xhr_mock_1.delay(l,i));break;case"POST":fetch_mock_1.default.post(t,function(){return addDelay(i).then(function(){return l})},{overwriteRoutes:!1}),xhr_mock_1.default.post(t,xhr_mock_1.delay(l,i));break;case"PUT":fetch_mock_1.default.put(t,function(){return addDelay(i).then(function(){return l})},{overwriteRoutes:!1}),xhr_mock_1.default.put(t,xhr_mock_1.delay(l,i));break;case"PATCH":fetch_mock_1.default.patch(t,function(){return addDelay(i).then(function(){return l})},{overwriteRoutes:!1}),xhr_mock_1.default.patch(t,xhr_mock_1.delay(l,i));break;case"DELETE":fetch_mock_1.default.delete(t,function(){return addDelay(i).then(function(){return l})},{overwriteRoutes:!1}),xhr_mock_1.default.delete(t,xhr_mock_1.delay(l,i));break;default:throw new Error("Unrecognised HTTP method ".concat(r," - please check your mock configuration"))}}function handleGraphQLMock(e){function c(e,r){return addDelay(e||0).then(function(){return r})}var r=e.url,i=e.operations,l={errors:[]};fetch_mock_1.default.get(r,function(e){var r,t=(r=new URL(e).searchParams.get("operationName"),i.find(function(e){return e.operationName===r}));if(!t||"mutation"===(null==t?void 0:t.type))return l;var o={body:t.response,status:t.responseCode,headers:t.responseHeaders};return c(t.delay,o)}),fetch_mock_1.default.post(r,function(e,r){var t,o,n=r.body,a=(o="string"==typeof(t=n)?JSON.parse(t):t,i.find(function(e){return e.operationName===o.operationName}));if(!a)return l;var u={body:a.response,status:a.responseCode,headers:a.responseHeaders};return c(a.delay,u)},{overwriteRoutes:!1})}exports.extractScenarioFromLocation=function(e){var r=query_string_1.parse(e.search).scenario,t=void 0===r?"default":r;if(Array.isArray(t))throw new Error("Only one scenario may be used at a time");return t},exports.injectMocks=function(e){var r,t,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default",n=2<arguments.length?arguments[2]:void 0;xhr_mock_1.default.setup(),fetch_mock_1.default.config.fallbackToNetwork=null!==(r=null==n?void 0:n.allowFetchPassthrough)&&void 0!==r&&r,fetch_mock_1.default.config.warnOnFallback=null===(t=null==n?void 0:n.disableConsoleWarningsForFetch)||void 0===t||t;var a="default"!==o?exports.reduceAllMocksForScenario(e,o):e.default;if(!a||0===a.length)throw new Error("Unable to instantiate mocks");var u=a.filter(function(e){return"GRAPHQL"!==e.method}),c=a.filter(function(e){return"GRAPHQL"===e.method});u.forEach(handleRestMock),c.forEach(handleGraphQLMock),null!=n&&n.allowXHRPassthrough&&xhr_mock_1.default.use(xhr_mock_1.proxy)},exports.reduceAllMocksForScenario=function(e,r){if("default"===r)return e.default;var t=e.default,o=e[r];if(!o)throw new Error("No mocks found for scenario '".concat(r,"'"));var n=t.concat(o),a=n.filter(function(e){return"GRAPHQL"!==e.method}),u=n.filter(function(e){return"GRAPHQL"===e.method}),c=a.reduce(function(e,r){var t=r.url,o=r.method;return e["".concat(t.toString()).concat(o)]=r,e},{}),i=Object.values(c),l=u.reduce(function(e,r){var t=r.url,o=r.operations,n=e[t.toString()]?e[t.toString()]:{};return o.forEach(function(e){n["".concat(e.operationName).concat(e.type)]=e}),e[t.toString()]=n,e},{}),s=Object.entries(l).map(function(e){var r=_slicedToArray(e,2),t=r[0],o=r[1];return{method:"GRAPHQL",url:RegExp(t.replace(/^\/(.*)\/$/,"$1")),operations:Object.values(o)}});return i.concat(s)};var addDelay=function(r){return new Promise(function(e){return setTimeout(e,r)})};